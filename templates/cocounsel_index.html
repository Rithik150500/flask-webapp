<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>leXploR</title>
    <!-- Meta tags for responsiveness -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Include Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&display=swap" rel="stylesheet"> <!-- Modern font -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:400,700&display=swap" rel="stylesheet"> <!-- Professional font -->
    <link href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:400,700&display=swap" rel="stylesheet"> <!-- Legal citation font -->

    <!-- Base CSS Styles -->
    <style>
    /* Base Styles */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Merriweather', serif;
        background-color: #f5f2e9; /* Muted, earthy background */
        color: #333;
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden; /* Prevent body scrolling */
    }

    /* Header */
    #header {
        text-align: center;
        padding: 20px;
        background-color: #8c8c8c; /* Muted gray */
        color: #fff;
    }

    #header h1 {
        font-size: 36px;
        font-weight: bold;
        font-family: 'Libre Baskerville', serif;
    }

    /* Input Container */
    #input-container {
        display: flex;
        justify-content: center;
        padding: 20px;
        background-color: #ede6d5; /* Light tan */
    }

    #dispute-input {
        width: 60%;
        height: 150px;
        border-radius: 10px;
        border: 1px solid #ccc;
        padding: 15px;
        font-size: 16px;
        resize: none;
        outline: none;
        background-color: #fff;
        font-family: 'Roboto', sans-serif; /* Modern font */
    }

    /* Lexplore and Submit Case File Buttons */
    #buttons-container {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 10px;
    }

    #lexplore-button,
    #submit-case-file-button {
        padding: 15px 30px;
        font-size: 18px;
        border-radius: 10px;
        background-color: #8c8c8c;
        color: #fff;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s;
        font-family: 'Merriweather', serif;
    }

    #lexplore-button:disabled,
    #submit-case-file-button:disabled {
        background-color: #b3b3b3;
        cursor: not-allowed;
    }

    #lexplore-button:hover:not(:disabled),
    #submit-case-file-button:hover:not(:disabled) {
        background-color: #6e6e6e;
    }

    /* Feature Description */
    #feature-description {
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background-color: #ede6d5;
        border-radius: 10px;
        text-align: left;
        line-height: 1.6;
        font-family: 'Merriweather', serif;
    }

    #feature-description p {
        font-size: 16px;
        margin-bottom: 10px;
    }

    #feature-description em {
        font-style: italic;
    }

    /* Main Content */
    #main-content {
        display: flex;
        flex-direction: column;
        flex: 1; /* Allow it to grow and fill available space */
        overflow: hidden; /* Hide overflow */
    }

    /* Legal Dispute Section */
    #dispute-display {
        width: 100%;
        padding: 10px 20px;
        background-color: #e0d8c3; /* Light beige */
        border-bottom: 1px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-family: 'Roboto', sans-serif;
        position: relative;
    }

    #dispute-text {
        flex: 1;
        text-align: center;
        padding: 0 20px;
        overflow-y: auto;
        max-height: 120px;
    }

    #dispute-logo-left,
    #dispute-logo-right {
        width: 100px;
        text-align: center;
        font-family: 'Libre Baskerville', serif;
        font-size: 24px;
        color: #8c8c8c;
        flex-shrink: 0;
    }

    /* Content Sections */
    #content-sections {
        display: flex;
        flex: 1; /* Allow it to grow and fill remaining space */
        overflow: hidden;
        background-color: #f5f2e9;
    }

    /* Memo Section */
    #memo-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border-right: 1px solid #ccc;
        background-color: #fdfbf6; /* Slightly lighter shade */
        font-family: 'Merriweather', serif;
    }

    /* Workspace Section */
    #workspace-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        font-family: 'Roboto', sans-serif; /* Modern font */
    }

    /* Research Section */
    #research-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border-left: 1px solid #ccc;
        background-color: #fdfbf6;
        font-family: 'Merriweather', serif;
    }

    /* Memo Content */
    #memo-section .content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        font-size: 18px; /* Increased font size */
    }

    #memo-section h3 {
        font-size: 18px; /* Smaller font size */
        margin-bottom: 10px;
        color: #5a5a5a;
        font-weight: bold;
        margin-top: 20px; /* Add space above headings */
    }

    #memo-section h3:first-child {
        margin-top: 0; /* Remove top margin for the first heading */
    }

    /* Research Content */
    #research-section .content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    #research-section .case-title {
        cursor: pointer;
        color: #333;
        margin-bottom: 10px;
        font-size: 18px; /* Increased font size */
        font-family: 'Libre Baskerville', serif; /* Legal citation font */
    }

    #research-section .case-title:hover {
        color: #000;
    }

    /* Loading Indicator */
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
        font-size: 24px;
        color: #555;
        font-family: 'Roboto', sans-serif;
    }

    /* Chat Interface */
    #chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    #chat-window {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        background-color: #fff;
    }

    .message {
        display: flex;
        margin-bottom: 15px;
        animation: fadeIn 0.3s ease-in-out;
    }

    .message.user {
        justify-content: flex-end;
    }

    .message.assistant {
        justify-content: flex-start;
    }

    .message .bubble {
        padding: 10px 15px;
        border-radius: 10px;
        position: relative;
        word-wrap: break-word;
        white-space: pre-wrap;
        font-family: 'Roboto', sans-serif; /* Modern font */
    }

    /* User message bubble */
    .message.user .bubble {
        background-color: #8c8c8c;
        color: #fff;
        border-bottom-right-radius: 0;
        max-width: 70%; /* User messages occupy up to 70% of width */
    }

    /* Assistant message bubble */
    .message.assistant .bubble {
        background-color: #e0d8c3;
        color: #000;
        border-bottom-left-radius: 0;
        width: 100%; /* Assistant messages occupy full width */
        margin-right: 0;
        margin-left: 0;
        padding: 15px; /* Optional: Increase padding for better readability */
    }

    /* Chat Input */
    #chat-input {
        display: flex;
        align-items: center;
        padding: 10px;
        background-color: #ede6d5;
        border-top: 1px solid #ccc;
        flex-shrink: 0;
    }

    #chat-input textarea {
        flex-grow: 1;
        resize: none;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 10px;
        background-color: #fff;
        font-size: 16px;
        outline: none;
        max-height: 150px;
        font-family: 'Roboto', sans-serif;
    }

    #chat-input button {
        margin-left: 10px;
        padding: 10px 20px;
        background-color: #8c8c8c;
        border: none;
        border-radius: 10px;
        color: #fff;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s;
        font-family: 'Merriweather', serif;
    }

    #chat-input button:disabled {
        background-color: #b3b3b3;
        cursor: not-allowed;
    }

    #chat-input button:hover:not(:disabled) {
        background-color: #6e6e6e;
    }

    /* Popup Styles */
    #case-popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    #case-popup .popup-content {
        background: #fff;
        width: 80%;
        height: 80%;
        display: flex;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
    }

    #case-popup #popup-left,
    #case-popup #popup-right {
        width: 50%;
        padding: 20px;
        overflow-y: auto;
        font-family: 'Merriweather', serif;
    }

    #case-popup #popup-left {
        border-right: 1px solid #ccc;
    }

    #close-popup {
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 30px;
        background: none;
        border: none;
        cursor: pointer;
        color: #aaa;
        transition: color 0.3s;
    }

    #close-popup:hover {
        color: #000;
    }

    /* Highlighted text */
    .highlighted {
        background-color: yellow;
    }

    /* Smooth transitions */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Responsive Design */
    @media (max-width: 800px) {
        body {
            overflow-y: auto;
        }

        #main-content {
            flex: none;
            height: auto;
        }

        #content-sections {
            flex-direction: column;
        }

        #memo-section,
        #workspace-section,
        #research-section {
            width: 100%;
            height: auto;
        }

        #dispute-display {
            max-height: none;
        }

        #dispute-text {
            max-height: none;
        }
    }

    /* Scrollbar Styling */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: #aaa;
    }
    /* Content Sections Adjusted Widths */
    #memo-section {
        flex: 0 0 35%; /* 30% width, don't grow or shrink */
    }

    #workspace-section {
        flex: 0 0 35%; /* 40% width, center section */
    }

    #research-section {
        flex: 0 0 30%; /* 30% width, don't grow or shrink */
    }

    /* Increased Font Size for Memo Content */
    #memo-section .content {
        font-size: 18px; /* Increased from 16px to 18px */
        line-height: 1.7; /* Slightly increased line height for better readability */
    }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header">
        <h1>leXploR</h1>
    </div>

    <!-- Input Container -->
    <div id="input-container">
        <textarea id="dispute-input" placeholder="Enter a legal problem"></textarea>
    </div>

    <!-- Buttons Container -->
    <div id="buttons-container">
        <button id="lexplore-button" disabled>Lexplore</button>
        <button id="submit-case-file-button" disabled>Submit Case File</button>
    </div>

    <!-- Feature Description Section -->
    <div id="feature-description">
        <p><strong>Enter Your Legal Problem Above:</strong> Provide a summary of your case or factual scenario in the text box.</p>
        <p><strong>Click "Lexplore":</strong> Initiate an AI-powered analysis tailored to your legal problem.</p>
        <p><strong>Receive a Detailed Memo:</strong> Get a professionally structured legal memo with relevant laws and precedents.</p>
        <p><strong>Engage with Our AI Assistant:</strong> Dive deeper by chatting with our AI for clarifications and further insights.</p>
        <p><strong>Explore Relevant Cases:</strong> Access summaries and full texts of pertinent cases, with key sections highlighted.</p>
        <p><em>Experience a smarter way to conduct legal research. Start by entering your legal problem above!</em></p>
    </div>

    <!-- Main Content -->
    <div id="main-content" style="display: none;">
        <!-- Legal Dispute Section -->
        <div id="dispute-display">
            <div id="dispute-logo-left">leXploR</div>
            <div id="dispute-text"><!-- Legal dispute text will be injected here --></div>
            <div id="dispute-logo-right">leXploR</div>
        </div>

        <!-- Content Sections -->
        <div id="content-sections">
            <!-- Left Section: Memo -->
            <div id="memo-section">
                <!-- Memo content will be injected here -->
            </div>
            <!-- Center Section: Workspace -->
            <div id="workspace-section">
                <!-- Chat Interface will be injected here -->
            </div>
            <!-- Right Section: Legal Research -->
            <div id="research-section">
                <!-- Legal Research will be displayed here -->
            </div>
        </div>
    </div>

    <!-- Case Popup -->
    <div id="case-popup">
        <div class="popup-content">
            <!-- Left Section: Case Summary -->
            <div id="popup-left">
                <div id="case-summary"></div>
            </div>
            <!-- Right Section: Case Text -->
            <div id="popup-right">
                <div id="case-text"></div>
            </div>
            <!-- Close Button -->
            <button id="close-popup">&times;</button>
        </div>
    </div>

    <!-- JavaScript Code -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        let disputeText = '';
        let conversation = []; // Initialize empty conversation
        let currentResponseData = null; // Higher scope variable for responseData
        let briefAndNarrative = ''; // Variable to store combined brief and narrative

        // Enable Lexplore and Submit Case File buttons when there is text
        document.getElementById('dispute-input').addEventListener('input', function() {
            const text = this.value.trim();
            document.getElementById('lexplore-button').disabled = text.length === 0;
            document.getElementById('submit-case-file-button').disabled = text.length === 0;
        });

        // Handle "Submit Case File" button click
        document.getElementById('submit-case-file-button').addEventListener('click', function() {
            disputeText = document.getElementById('dispute-input').value.trim();
            if (disputeText.length === 0) {
                alert('Please enter the case file text.');
                return;
            }

            // Hide the initial elements
            document.getElementById('header').style.display = 'none';
            document.getElementById('input-container').style.display = 'none';
            document.getElementById('buttons-container').style.display = 'none';
            document.getElementById('feature-description').style.display = 'none'; // Hide the feature description

            // Show loading indicator
            document.getElementById('main-content').style.display = 'flex';

            // Display loading indicator in workspace section
            document.getElementById('workspace-section').innerHTML = '<div class="loading">Processing the case file...</div>';
            document.getElementById('memo-section').innerHTML = '';
            document.getElementById('research-section').innerHTML = '';

            // Send the case file content to the backend
            fetch('/submit_case_file', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ case_file_content: disputeText }),
            })
            .then(response => response.json())
            .then(responseData => {
                if (responseData.error) {
                    alert(responseData.error);
                    resetUI();
                    return;
                }

                // Hide loading indicator
                document.getElementById('main-content').style.display = 'none';

                // Display the brief and narrative
                // Handle as per your application's requirement

                // Proceed to processing the dispute
                startProcessingDispute(responseData.case_brief + '\n\n' + responseData.factual_narrative);
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred while processing the case file.');
                resetUI();
            });
        });

        // Function to start processing the dispute (refactored from Lexplore button click handler)
        function startProcessingDispute(disputeText) {
            // Hide the initial elements
            document.getElementById('header').style.display = 'none';
            document.getElementById('input-container').style.display = 'none';
            document.getElementById('buttons-container').style.display = 'none';
            document.getElementById('feature-description').style.display = 'none'; // Hide the feature description

            // Show the main content
            document.getElementById('main-content').style.display = 'flex';

            // Display the legal dispute in the top section
            document.getElementById('dispute-text').innerHTML = `<div>${formatText(disputeText, true)}</div>`;

            // Display loading indicators in the sections
            document.getElementById('workspace-section').innerHTML = '<div class="loading">Setting up your workspace...</div>';
            document.getElementById('memo-section').innerHTML = ''; // Remove loading indicator from memo section
            document.getElementById('research-section').innerHTML = '';

            // Send AJAX request to backend to process dispute
            fetch('/process_dispute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ dispute: disputeText }),
            })
            .then(response => response.json())
            .then(responseData => {
                if (responseData.error) {
                    alert(responseData.error);
                    resetUI();
                    return;
                }

                const jobId = responseData.job_id;

                // Start polling for job result
                pollJobResult(jobId);

            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred while processing the dispute.');
                resetUI();
            });
        }

        // Modify the existing Lexplore button click handler to use the new function
        document.getElementById('lexplore-button').addEventListener('click', function() {
            disputeText = document.getElementById('dispute-input').value.trim();
            if (disputeText.length === 0) {
                alert('Please enter a legal dispute.');
                return;
            }

            startProcessingDispute(disputeText);
        });

        // Function to poll for job result
        function pollJobResult(jobId) {
            const interval = setInterval(() => {
                fetch(`/get_job_result?job_id=${jobId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'completed') {
                            clearInterval(interval);
                            handleJobResult(data.result);
                        } else if (data.status === 'failed') {
                            clearInterval(interval);
                            alert(data.result.error || 'An error occurred while processing the dispute.');
                            resetUI();
                        } else if (data.current_step === 'initial_memo_done') {
                            clearInterval(interval); // Stop polling temporarily
                            displayCaseLawReading(data.case_names, jobId);
                        } else if (data.current_step === 'cases_found') {
                            // Update the UI to display the legal research section
                            displayLegalResearch(data.cases);
                            // Update the workspace section message
                            updateLoadingMessage('generating_memo');
                        } else {
                            console.log('Processing...');
                            // Optionally, update a loading indicator
                            updateLoadingMessage(data.current_step);
                        }
                    })
                    .catch(error => {
                        clearInterval(interval);
                        console.error('Error fetching job result:', error);
                        alert('An error occurred while fetching the job result.');
                        resetUI();
                    });
            }, 5000); // Poll every 5 seconds
        }

        // Function to update loading messages based on current step
        function updateLoadingMessage(step) {
            switch (step) {
                case 'analyzing_dispute':
                    document.getElementById('workspace-section').innerHTML = '<div class="loading">Analyzing legal problem...</div>';
                    break;
                case 'initial_memo_done':
                    // Handled separately in displayCaseLawReading function
                    break;
                case 'retrieving_cases':
                    document.getElementById('workspace-section').innerHTML = '<div class="loading">Retrieving relevant case laws...</div>';
                    break;
                case 'cases_found':
                    // Handled separately in displayLegalResearch function
                    break;
                case 'generating_memo':
                    document.getElementById('workspace-section').innerHTML = '<div class="loading">Drafting research memo...</div>';
                    break;
                default:
                    document.getElementById('workspace-section').innerHTML = '<div class="loading">Processing...</div>';
            }
        }

        // Function to display case law reading messages
        function displayCaseLawReading(caseNames, jobId) {
            let index = 0;

            function showNextCaseLaw() {
                if (index < caseNames.length) {
                    document.getElementById('workspace-section').innerHTML = `<div class="loading">Reading - ${caseNames[index]}</div>`;
                    index++;
                    setTimeout(showNextCaseLaw, 5000); // Update every 5 seconds
                } else {
                    // After all case laws, resume polling
                    pollJobResult(jobId);
                }
            }

            showNextCaseLaw();
        }

        // Function to display legal research section
        function displayLegalResearch(cases) {
            // Sort cases alphabetically by case_title
            cases.sort((a, b) => a.case_title.localeCompare(b.case_title));

            // Update research-section with Legal Research
            var researchContent = '';
            researchContent += '<div class="content">';
            cases.forEach(function(caseItem) {
                researchContent += `<p class="case-title" data-doc-id="${caseItem.doc_id}" data-analysis-ids='${JSON.stringify(caseItem.analysis_reasoning_ids)}'>${caseItem.case_title}</p>`;
            });
            researchContent += '</div>';

            document.getElementById('research-section').innerHTML = researchContent;

            // Optionally, add event listeners to the case titles
            document.querySelectorAll('#research-section .case-title').forEach(function(element) {
                element.addEventListener('click', function() {
                    const docId = this.getAttribute('data-doc-id');
                    const analysisIds = JSON.parse(this.getAttribute('data-analysis-ids'));
                    fetchCaseDetails(docId, analysisIds, this.textContent);
                });
            });
        }

        // Function to handle the job result
        function handleJobResult(responseData) {
            if (responseData.error) {
                alert(responseData.error);
                resetUI();
                return;
            }

            // Assign responseData to the higher scope variable
            currentResponseData = responseData;

            // Initialize conversation with initial_conversation
            conversation = responseData.initial_conversation;

            // Update the workspace section to display the chat interface
            document.getElementById('workspace-section').innerHTML = ''; // Clear the loading indicator

            // Initialize the chat interface in workspace-section
            document.getElementById('workspace-section').innerHTML = `
                <div id="chat-container">
                    <!-- Chat Window -->
                    <div id="chat-window">
                        <!-- Messages will be appended here -->
                    </div>

                    <!-- Chat Input -->
                    <div id="chat-input">
                        <textarea id="user-input" placeholder="Type your message here..."></textarea>
                        <button id="send-button" disabled>Send</button>
                    </div>
                </div>
            `;

            // Format the memo content
            var formattedMemo = formatMemoContent(responseData.final_memo);

            // Update the memo section to display the Research Memo
            document.getElementById('memo-section').innerHTML = `
                <div class="content">${formattedMemo}</div>
            `;

            // Update the research section to display Legal Research
            displayLegalResearch(responseData.cases);

            // Handle chat input
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');

            userInput.addEventListener('input', function() {
                const text = this.value.trim();
                sendButton.disabled = text.length === 0;
            });

            sendButton.addEventListener('click', function() {
                const message = userInput.value.trim();
                if (message.length === 0) return;

                // Add user message to chat window
                addMessage('user', message);
                userInput.value = '';
                sendButton.disabled = true; // Disable the send button

                // Append user message to conversation
                conversation.push({
                    "role": "user",
                    "content": message
                });

                // Ensure the number of user messages does not exceed 20
                const userMessageCount = conversation.filter(msg => msg.role === 'user').length;
                if (userMessageCount > 20) {
                    // Remove the oldest user message and the corresponding assistant message
                    for (let i = 0; i < conversation.length; i++) {
                        if (conversation[i].role === 'user') {
                            conversation.splice(i, 2); // Remove user and assistant message
                            break;
                        }
                    }
                }

                // Send message to backend
                sendMessageToBackend(message);
            });

            // Add event listeners to case titles
            document.querySelectorAll('#research-section .case-title').forEach(function(element) {
                element.addEventListener('click', function() {
                    const docId = this.getAttribute('data-doc-id');
                    const analysisIds = JSON.parse(this.getAttribute('data-analysis-ids'));
                    fetchCaseDetails(docId, analysisIds, this.textContent);
                });
            });
        }

        function formatText(text, escapeHtml = true) {
            if (escapeHtml) {
                // Escape HTML special characters to prevent XSS
                text = text.replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;');
            }
            // Replace line breaks with <br>
            return text.replace(/\n/g, '<br>');
        }

        function formatMemoContent(memoContent) {
            // Extract content between <memo> and </memo>
            const memoRegex = /<memo>([\s\S]*?)<\/memo>/;
            const memoMatch = memoContent.match(memoRegex);
            if (!memoMatch) {
                // If no <memo> tags are found, return the original content
                return memoContent;
            }
            let content = memoMatch[1];

            // Remove excessive line breaks
            content = content.replace(/\n{2,}/g, '\n');

            // Mapping of tags to headings
            const tagHeadingMap = {
                '<brief_facts>': '<h3>Facts</h3>',
                '</brief_facts>': '',
                '<issues_involved>': '<h3>Legal Issues</h3>',
                '</issues_involved>': '',
                '<laws_involved>': '<h3>Laws Involved</h3>',
                '</laws_involved>': '',
                '<discussion_reasoning>': '<h3>Discussion</h3>',
                '</discussion_reasoning>': '',
                '<findings_conclusion>': '<h3>Findings</h3>',
                '</findings_conclusion>': '',
            };

            // Replace tags with headings
            Object.keys(tagHeadingMap).forEach(tag => {
                const heading = tagHeadingMap[tag];
                const tagRegex = new RegExp(tag, 'g');
                content = content.replace(tagRegex, heading);
            });

            // Escape HTML in the content
            content = content.replace(/&/g, '&amp;')
                                .replace(/</g, '&lt;')
                                .replace(/>/g, '&gt;');

            // Restore headings (they should not be escaped)
            content = content.replace(/&lt;h3&gt;/g, '<h3>')
                                .replace(/&lt;\/h3&gt;/g, '</h3>');

            // Replace line breaks with <br>
            content = content.replace(/\n/g, '<br>');

            return content;
        }

        function addMessage(sender, text) {
            const chatWindow = document.getElementById('chat-window');
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', sender);

            const bubbleDiv = document.createElement('div');
            bubbleDiv.classList.add('bubble');
            bubbleDiv.innerHTML = formatText(text);

            messageDiv.appendChild(bubbleDiv);
            chatWindow.appendChild(messageDiv);

            // Scroll to bottom
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function sendMessageToBackend(message) {
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ conversation: conversation, user_task: message }),
            })
            .then(response => response.json())
            .then(responseData => {
                if (responseData.error) {
                    alert(responseData.error);
                    return;
                }

                // Update the conversation with the latest messages
                conversation = responseData.conversation;

                // Add assistant message to chat window
                addMessage('assistant', responseData.assistant_response);

                // Re-enable the send button
                document.getElementById('send-button').disabled = false;
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('An error occurred while sending the message.');
                // Re-enable the send button in case of error
                document.getElementById('send-button').disabled = false;
            });
        }

        function resetUI() {
            // Reset the UI to initial state
            document.getElementById('header').style.display = 'block';
            document.getElementById('input-container').style.display = 'flex';
            document.getElementById('buttons-container').style.display = 'flex';
            document.getElementById('lexplore-button').style.display = 'block';
            document.getElementById('main-content').style.display = 'none';
            document.getElementById('dispute-input').value = '';
            document.getElementById('lexplore-button').disabled = true;
            document.getElementById('submit-case-file-button').disabled = true;
        }

        function fetchCaseDetails(docId, analysisIds, caseTitle) {
            // Show loading indicators
            document.getElementById('case-summary').innerHTML = '<p>Loading summary...</p>';
            document.getElementById('case-text').innerHTML = '<p>Loading case text...</p>';

            // Show the popup
            document.getElementById('case-popup').style.display = 'flex';

            // Fetch case details from backend
            fetch('/get_case_details', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    document_id: parseInt(docId),
                    analysis_reasoning_ids: analysisIds || []
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    document.getElementById('case-summary').innerHTML = `<p>${data.error}</p>`;
                    document.getElementById('case-text').innerHTML = '';
                    return;
                }

                // Display case summary
                const summary = data.case_summary;
                let summaryHtml = `<h3>${summary.case_title}</h3>`;
                // Display citations just below the case title
                if (summary.eq_citations && summary.eq_citations.length > 0) {
                    summaryHtml += `<p><strong>Citations:</strong> ${summary.eq_citations.join('; ')}</p>`;
                }
                summaryHtml += `<p><strong>Background Facts:</strong> ${summary.background_facts}</p>`;
                summaryHtml += `<p><strong>Legal Issues:</strong> ${summary.legal_issues.map(issue => issue.text).join('; ')}</p>`;
                summaryHtml += `<p><strong>Arguments:</strong> ${summary.arguments.map(arg => arg.text).join('; ')}</p>`;
                // Add Analysis Reasoning with highlighting
                if (summary.analysis_reasoning && summary.analysis_reasoning.length > 0) {
                    summaryHtml += `<p><strong>Analysis Reasoning:</strong></p><ul>`;
                    summary.analysis_reasoning.forEach(ar => {
                        if (ar.highlight) {
                            summaryHtml += `<li class="highlighted">${ar.text}</li>`;
                        } else {
                            summaryHtml += `<li>${ar.text}</li>`;
                        }
                    });
                    summaryHtml += `</ul>`;
                }

                summaryHtml += `<p><strong>Decision Order:</strong> ${summary.decision_order}</p>`;
                summaryHtml += `<p><strong>Dissenting/Concurring Opinions:</strong> ${summary.dissenting_concurring.map(dc => dc.text).join('; ')}</p>`;

                // Add Cases Referred Section if it exists
                if (summary.cases_referred && summary.cases_referred.length > 0) {
                    summaryHtml += `<p><strong>Cases Referred:</strong></p><ul>`;
                    summary.cases_referred.forEach(caseRef => {
                        summaryHtml += `<li class="case-referred" data-doc-id="${caseRef.document_id}">${caseRef.case_title}</li>`;
                    });
                    summaryHtml += `</ul>`;
                }

                document.getElementById('case-summary').innerHTML = summaryHtml;

                // Display case text with highlights
                const caseText = data.case_text;
                let highlightedText = caseText;

                if (analysisIds && analysisIds.length > 0) {
                    // Highlight paragraphs related to analysis_reasoning_ids
                    analysisIds.forEach(ar_id => {
                        const regex = new RegExp(`data-summary-cites="${ar_id}"`, 'g');
                        highlightedText = highlightedText.replace(regex, 'style="background-color: yellow;" data-summary-cites');
                    });
                }

                document.getElementById('case-text').innerHTML = highlightedText;

                // Attach event listeners to cases referred
                document.querySelectorAll('.case-referred').forEach(function(element) {
                    element.addEventListener('click', function(event) {
                        event.stopPropagation(); // Prevent event bubbling
                        const docId = this.getAttribute('data-doc-id');
                        fetchCaseDetails(docId, [], this.textContent);
                    });
                });

            })
            .catch(error => {
                console.error('Error fetching case details:', error);
                document.getElementById('case-summary').innerHTML = '<p>An error occurred while fetching case details.</p>';
                document.getElementById('case-text').innerHTML = '';
            });
        }

        // Handle closing the popup
        document.getElementById('close-popup').addEventListener('click', function() {
            document.getElementById('case-popup').style.display = 'none';
        });

        // Optional: Close popup when clicking outside the popup content
        document.getElementById('case-popup').addEventListener('click', function(event) {
            if (event.target === this) {
                this.style.display = 'none';
            }
        });
    });
    </script>
</body>
</html>
